#!/usr/bin/env bash
# FetaruteTCAddon: pre-push hook
set -euo pipefail

remote_name="${1:-}"
remote_url="${2:-}"

if [[ "${SKIP_GIT_HOOKS:-}" == "1" || "${SKIP_GIT_HOOKS:-}" == "true" || "${FTA_SKIP_PRE_PUSH:-}" == "1" ]]; then
  exit 0
fi

repo_root="$(git rev-parse --show-toplevel 2>/dev/null || true)"
if [[ -z "${repo_root}" ]]; then
  echo "pre-push: not a git repository; skipping" >&2
  exit 0
fi

cd "${repo_root}"

export GRADLE_USER_HOME="${GRADLE_USER_HOME:-${repo_root}/.gradle}"

if [[ ! -x "./gradlew" ]]; then
  echo "pre-push: ./gradlew not found or not executable; skipping" >&2
  exit 0
fi

echo "pre-push: running './gradlew clean check' (remote=${remote_name} url=${remote_url})" >&2
./gradlew clean check </dev/null
